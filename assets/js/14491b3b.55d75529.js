"use strict";(self.webpackChunkfullstackbook=self.webpackChunkfullstackbook||[]).push([[9401],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>d});var n=r(7294);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){s(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,n,s=function(e,t){if(null==e)return{};var r,n,s={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(s[r]=e[r]);return s}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(s[r]=e[r])}return s}var p=n.createContext({}),l=function(e){var t=n.useContext(p),r=t;return e&&(r="function"==typeof e?e(t):a(a({},t),e)),r},c=function(e){var t=l(e.components);return n.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,s=e.mdxType,o=e.originalType,p=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),m=l(r),d=s,g=m["".concat(p,".").concat(d)]||m[d]||u[d]||o;return r?n.createElement(g,a(a({ref:t},c),{},{components:r})):n.createElement(g,a({ref:t},c))}));function d(e,t){var r=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var o=r.length,a=new Array(o);a[0]=m;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i.mdxType="string"==typeof e?e:s,a[1]=i;for(var l=2;l<o;l++)a[l]=r[l];return n.createElement.apply(null,a)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},5981:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>p,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var n=r(7462),s=(r(7294),r(3905));const o={},a="NestJS JWT API",i={unversionedId:"backend/nestjs-jwt",id:"backend/nestjs-jwt",title:"NestJS JWT API",description:"- GitHub//github.com/travisluong/fullstackbook-nestjs-jwt",source:"@site/docs/backend/nestjs-jwt.md",sourceDirName:"backend",slug:"/backend/nestjs-jwt",permalink:"/fullstackbook/backend/nestjs-jwt",draft:!1,editUrl:"https://github.com/travisluong/fullstackbook/tree/main/docs/backend/nestjs-jwt.md",tags:[],version:"current",frontMatter:{},sidebar:"backendSidebar",previous:{title:"MVC",permalink:"/fullstackbook/backend/mvc"},next:{title:"NestJS To Do API",permalink:"/fullstackbook/backend/nestjs-todo"}},p={},l=[{value:"Command Line",id:"command-line",level:2},{value:"Auth",id:"auth",level:2},{value:"Migration",id:"migration",level:2},{value:"Users",id:"users",level:2},{value:"Src",id:"src",level:2},{value:"Test",id:"test",level:2},{value:"Root",id:"root",level:2},{value:"Reference",id:"reference",level:2}],c={toc:l};function u(e){let{components:t,...r}=e;return(0,s.kt)("wrapper",(0,n.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"nestjs-jwt-api"},"NestJS JWT API"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"GitHub: ",(0,s.kt)("a",{parentName:"li",href:"https://github.com/travisluong/fullstackbook-nestjs-jwt"},"https://github.com/travisluong/fullstackbook-nestjs-jwt")),(0,s.kt)("li",{parentName:"ul"},"YouTube: ",(0,s.kt)("a",{parentName:"li",href:"https://youtu.be/Hbj_Wdqk3MM"},"Full Stack NestJS + NextJS JWT Authentication"))),(0,s.kt)("h2",{id:"command-line"},"Command Line"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title="Terminal"',title:'"Terminal"'},"npm i -g @nestjs/cli\nnest new fullstackbook-nestjs-jwt\nnpm install --save @nestjs/passport passport passport-local\nnpm install --save-dev @types/passport-local\nnest g module auth\nnest g service auth\nnest g module users\nnest g service users\ncreatedb fullstackbook-nestjs-jwt\nnpm i --save @nestjs/config @nestjs/typeorm typeorm pg\nnpx typeorm migration:create src/migration/create-users-table\nnpx typeorm migration:create src/migration/create-roles-table\nnpx typeorm migration:create src/migration/create-users-to-roles-table\nnpx typeorm migration:create src/migration/insert-roles\nnpm run typeorm migration:run\nnpm run typeorm migration:revert\nnpm i bcrypt\nnpm i -D @types/bcrypt\n")),(0,s.kt)("h2",{id:"auth"},"Auth"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/auth.module.ts"',title:'"src/auth/auth.module.ts"'},"import { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { LocalStrategy } from './local.strategy';\nimport { JwtStrategy } from './jwt.strategy';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { JwtModule } from '@nestjs/jwt';\nimport { jwtConstants } from './constants';\n\n@Module({\n  imports: [\n    UsersModule,\n    PassportModule,\n    JwtModule.register({\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '6000s' },\n    }),\n  ],\n  providers: [AuthService, LocalStrategy, JwtStrategy],\n  exports: [AuthService],\n})\nexport class AuthModule { }\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/auth.service.spec.ts"',title:'"src/auth/auth.service.spec.ts"'},"import { JwtService } from '@nestjs/jwt';\nimport { Test, TestingModule } from '@nestjs/testing';\nimport { databaseProviders } from 'src/database.providers';\nimport { userProviders } from 'src/users/users.providers';\nimport { UsersService } from 'src/users/users.service';\nimport { AuthService } from './auth.service';\n\ndescribe('AuthService', () => {\n  let service: AuthService;\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [AuthService, UsersService, JwtService, ...userProviders, ...databaseProviders],\n    }).compile();\n\n    service = module.get<AuthService>(AuthService);\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n});\n\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/auth.service.ts"',title:'"src/auth/auth.service.ts"'},"import { HttpException, HttpStatus, Injectable } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\nimport { JwtService } from '@nestjs/jwt';\nimport * as bcrypt from 'bcrypt';\n\nconst saltOrRounds = 10;\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private usersService: UsersService,\n    private jwtService: JwtService\n  ) { }\n\n  async validateUser(username: string, pass: string): Promise<any> {\n    const user = await this.usersService.findOne(username);\n\n    if (user) {\n      const isMatch = await bcrypt.compare(pass, user.password);\n      if (!isMatch) {\n        return null;\n      }\n      const { password, ...result } = user;\n      return result;\n    }\n    return null;\n  }\n\n  async login(user: any) {\n    const payload = { username: user.username, sub: user.id };\n    return {\n      token: this.jwtService.sign(payload),\n    };\n  }\n\n  async signup(username: string, password: string): Promise<any> {\n    const user = await this.usersService.findOne(username);\n    if (user) {\n      throw new HttpException('Username taken', HttpStatus.BAD_REQUEST);\n    }\n    const hash = await bcrypt.hash(password, saltOrRounds);\n    const newUser = await this.usersService.create(username, hash);\n    return {\n      id: newUser.id\n    };\n  }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/constants.ts"',title:'"src/auth/constants.ts"'},"export const jwtConstants = {\n  secret: 'secretKey',\n};\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/jwt-auth.guard.ts"',title:'"src/auth/jwt-auth.guard.ts"'},"import { Injectable } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Injectable()\nexport class JwtAuthGuard extends AuthGuard('jwt') { }\n\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/jwt.strategy.ts"',title:'"src/auth/jwt.strategy.ts"'},"import { ExtractJwt, Strategy } from 'passport-jwt';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Injectable } from '@nestjs/common';\nimport { jwtConstants } from './constants';\n\n@Injectable()\nexport class JwtStrategy extends PassportStrategy(Strategy) {\n  constructor() {\n    super({\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n      ignoreExpiration: false,\n      secretOrKey: jwtConstants.secret,\n    });\n  }\n\n  async validate(payload: any) {\n    return { userId: payload.sub, username: payload.username };\n  }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/local-auth.guard.ts"',title:'"src/auth/local-auth.guard.ts"'},"import { Injectable } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Injectable()\nexport class LocalAuthGuard extends AuthGuard('local') { }\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/local.strategy.ts"',title:'"src/auth/local.strategy.ts"'},"import { Strategy } from 'passport-local';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { AuthService } from './auth.service';\n\n@Injectable()\nexport class LocalStrategy extends PassportStrategy(Strategy) {\n  constructor(private authService: AuthService) {\n    super();\n  }\n\n  async validate(username: string, password: string): Promise<any> {\n    const user = await this.authService.validateUser(username, password);\n    if (!user) {\n      throw new UnauthorizedException();\n    }\n    return user;\n  }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/role.entity.ts"',title:'"src/auth/role.entity.ts"'},'import { ERole } from "src/auth/role.enum";\nimport { Column, Entity, PrimaryGeneratedColumn } from "typeorm";\n\n@Entity("roles")\nexport class Role {\n  @PrimaryGeneratedColumn()\n  id: number\n\n  @Column({\n    type: "enum",\n    enum: ERole\n  })\n  name: string\n}\n')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/role.enum.ts"',title:'"src/auth/role.enum.ts"'},"export enum ERole {\n  User = 'user',\n  Admin = 'admin',\n  Moderator = 'moderator',\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/roles.decorator.ts"',title:'"src/auth/roles.decorator.ts"'},"import { SetMetadata } from '@nestjs/common';\nimport { ERole } from './role.enum';\n\nexport const ROLES_KEY = 'roles';\nexport const Roles = (...roles: ERole[]) => SetMetadata(ROLES_KEY, roles);\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/roles.guard.ts"',title:'"src/auth/roles.guard.ts"'},"import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { UsersService } from 'src/users/users.service';\nimport { ERole } from './role.enum';\nimport { ROLES_KEY } from './roles.decorator';\n\n@Injectable()\nexport class RolesGuard implements CanActivate {\n  constructor(private reflector: Reflector, private userService: UsersService) { }\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const requiredRoles = this.reflector.getAllAndOverride<ERole[]>(ROLES_KEY, [\n      context.getHandler(),\n      context.getClass(),\n    ]);\n    if (!requiredRoles) {\n      return true;\n    }\n    const { user } = context.switchToHttp().getRequest();\n    const dbUser = await this.userService.findOne(user.username);\n\n    return requiredRoles.some((role) => dbUser.roles?.some((r) => r.name == role));\n  }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/auth/signup.dto.ts"',title:'"src/auth/signup.dto.ts"'},"export class SignUpDto {\n  username: string;\n  password: string;\n}\n")),(0,s.kt)("h2",{id:"migration"},"Migration"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/migration/1670117706569-create-users-table.ts"',title:'"src/migration/1670117706569-create-users-table.ts"'},'import { MigrationInterface, QueryRunner } from "typeorm"\n\nexport class createUsersTable1670117706569 implements MigrationInterface {\n\n    public async up(queryRunner: QueryRunner): Promise<void> {\n        await queryRunner.query(`\n        create table users (\n            id serial primary key,\n            username text not null,\n            password text\n        );\n        `)\n    }\n\n    public async down(queryRunner: QueryRunner): Promise<void> {\n        await queryRunner.query(`drop table users;`)\n    }\n\n}\n\n')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/migration/1670117718357-create-roles-table.ts"',title:'"src/migration/1670117718357-create-roles-table.ts"'},'import { MigrationInterface, QueryRunner } from "typeorm"\n\nexport class createRolesTable1670117718357 implements MigrationInterface {\n\n    public async up(queryRunner: QueryRunner): Promise<void> {\n        queryRunner.query(`\n        create table roles (\n            id serial primary key,\n            name text not null unique\n        );        \n        `)\n    }\n\n    public async down(queryRunner: QueryRunner): Promise<void> {\n        queryRunner.query(`drop table roles;`)\n    }\n\n}\n\n')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/migration/1670117726211-create-users-to-roles-table.ts"',title:'"src/migration/1670117726211-create-users-to-roles-table.ts"'},'import { MigrationInterface, QueryRunner } from "typeorm"\n\nexport class createUsersToRolesTable1670117726211 implements MigrationInterface {\n\n    public async up(queryRunner: QueryRunner): Promise<void> {\n        queryRunner.query(`\n        create table users_to_roles (\n            user_id int references users (id),\n            role_id int references roles (id)\n        );\n        `)\n    }\n\n    public async down(queryRunner: QueryRunner): Promise<void> {\n        queryRunner.query(`drop table users_to_roles;`)\n    }\n\n}\n\n')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/migration/1670117734416-insert-roles.ts"',title:'"src/migration/1670117734416-insert-roles.ts"'},"import { MigrationInterface, QueryRunner } from \"typeorm\"\n\nexport class insertRoles1670117734416 implements MigrationInterface {\n\n    public async up(queryRunner: QueryRunner): Promise<void> {\n        queryRunner.query(`\n        insert into roles (name) values ('user');\n        insert into roles (name) values ('moderator');\n        insert into roles (name) values ('admin');\n        `)\n    }\n\n    public async down(queryRunner: QueryRunner): Promise<void> {\n    }\n\n}\n\n")),(0,s.kt)("h2",{id:"users"},"Users"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/users/user.dto.ts"',title:'"src/users/user.dto.ts"'},"export class UserDto {\n  id: number;\n  username: string;\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/users/user.entity.ts"',title:'"src/users/user.entity.ts"'},'import { Column, Entity, JoinTable, ManyToMany, PrimaryGeneratedColumn } from "typeorm";\nimport { Role } from "../auth/role.entity";\n\n@Entity("users")\nexport class User {\n  @PrimaryGeneratedColumn()\n  id: number\n\n  @Column()\n  username: string\n\n  @Column()\n  password: string\n\n  @ManyToMany(() => Role)\n  @JoinTable({\n    name: "users_to_roles",\n    joinColumn: {\n      name: "user_id",\n      referencedColumnName: "id"\n    },\n    inverseJoinColumn: {\n      name: "role_id",\n      referencedColumnName: "id"\n    }\n  })\n  roles: Role[]\n}\n')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/users/users.module.ts"',title:'"src/users/users.module.ts"'},"import { Module } from '@nestjs/common';\nimport { DatabaseModule } from 'src/database.module';\nimport { userProviders } from './users.providers';\nimport { UsersService } from './users.service';\n\n@Module({\n  imports: [DatabaseModule],\n  providers: [UsersService, ...userProviders],\n  exports: [UsersService],\n})\nexport class UsersModule { }\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/users/users.providers.ts"',title:'"src/users/users.providers.ts"'},"import { DataSource } from 'typeorm';\nimport { User } from './user.entity';\n\nexport const userProviders = [\n  {\n    provide: 'USER_REPOSITORY',\n    useFactory: (dataSource: DataSource) => dataSource.getRepository(User),\n    inject: ['DATA_SOURCE'],\n  },\n];\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/users/users.service.spec.ts"',title:'"src/users/users.service.spec.ts"'},"import { Test, TestingModule } from '@nestjs/testing';\nimport { databaseProviders } from 'src/database.providers';\nimport { userProviders } from './users.providers';\nimport { UsersService } from './users.service';\n\ndescribe('UsersService', () => {\n  let service: UsersService;\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [UsersService, ...userProviders, ...databaseProviders],\n    }).compile();\n\n    service = module.get<UsersService>(UsersService);\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n});\n\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/users/users.service.ts"',title:'"src/users/users.service.ts"'},"import { Inject, Injectable } from '@nestjs/common';\nimport { Repository } from 'typeorm';\nimport { Role } from '../auth/role.entity';\nimport { UserDto } from './user.dto';\nimport { User } from './user.entity';\n\n@Injectable()\nexport class UsersService {\n  constructor(@Inject('USER_REPOSITORY')\n  private userRepository: Repository<User>,\n  ) { }\n\n  async findOne(username: string): Promise<User | undefined> {\n    const user = await this.userRepository.findOne({ where: { username }, relations: { roles: true } });\n    return user;\n  }\n\n  async getProfile(username: string): Promise<UserDto | undefined> {\n    const user = await this.userRepository.findOne({ where: { username } });\n    if (!user) {\n      return undefined;\n    }\n    const userDto = new UserDto();\n    userDto.id = user.id;\n    userDto.username = user.username;\n    return userDto;\n  }\n\n  async create(username: string, password: string): Promise<User | undefined> {\n    const user = new User();\n    user.username = username;\n    user.password = password;\n    const role = new Role();\n    role.id = 1;\n    user.roles = [role];\n    await this.userRepository.save(user);\n    return user;\n  }\n}\n")),(0,s.kt)("h2",{id:"src"},"Src"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/app.controller.spec.ts"',title:'"src/app.controller.spec.ts"'},"import { JwtService } from '@nestjs/jwt';\nimport { Test, TestingModule } from '@nestjs/testing';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport { AuthService } from './auth/auth.service';\nimport { databaseProviders } from './database.providers';\nimport { userProviders } from './users/users.providers';\nimport { UsersService } from './users/users.service';\n\ndescribe('AppController', () => {\n  let appController: AppController;\n\n  beforeEach(async () => {\n    const app: TestingModule = await Test.createTestingModule({\n      controllers: [AppController],\n      providers: [AppService, UsersService, ...userProviders, ...databaseProviders, AuthService, JwtService],\n    }).compile();\n\n    appController = app.get<AppController>(AppController);\n  });\n\n  describe('root', () => {\n    it('should return \"Hello World!\"', () => {\n      expect(appController.getHello()).toBe('Hello World!');\n    });\n  });\n});\n\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/app.controller.ts"',title:'"src/app.controller.ts"'},"import { Controller, Request, Post, Get, UseGuards, Body } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\nimport { AppService } from './app.service';\nimport { AuthService } from './auth/auth.service';\nimport { JwtAuthGuard } from './auth/jwt-auth.guard';\nimport { LocalAuthGuard } from './auth/local-auth.guard';\nimport { ERole } from './auth/role.enum';\nimport { Roles } from './auth/roles.decorator';\nimport { RolesGuard } from './auth/roles.guard';\nimport { SignUpDto } from './auth/signup.dto';\nimport { UsersService } from './users/users.service';\n\n@Controller()\nexport class AppController {\n  constructor(private readonly appService: AppService, private authService: AuthService, private userService: UsersService) { }\n\n  @Get()\n  getHello(): string {\n    return this.appService.getHello();\n  }\n\n  @UseGuards(LocalAuthGuard)\n  @Post('api/auth/signin')\n  async login(@Request() req) {\n    return this.authService.login(req.user);\n  }\n\n  @Post('api/auth/signup')\n  async signup(@Body() signUpDto: SignUpDto) {\n    return this.authService.signup(signUpDto.username, signUpDto.password);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('api/test/profile')\n  async getProfile(@Request() req) {\n    const user = await this.userService.getProfile(req.user.username);\n    return req.user;\n  }\n\n  @UseGuards(JwtAuthGuard, RolesGuard)\n  @Roles(ERole.Admin)\n  @Get('api/test/user')\n  getProtected() {\n    return \"protected data\";\n  }\n}\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/app.module.ts"',title:'"src/app.module.ts"'},"import { Module } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport { AuthModule } from './auth/auth.module';\nimport { UsersModule } from './users/users.module';\n\n@Module({\n  imports: [AuthModule, UsersModule],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule { }\n\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/app.service.ts"',title:'"src/app.service.ts"'},"import { Injectable } from '@nestjs/common';\n\n@Injectable()\nexport class AppService {\n  getHello(): string {\n    return 'Hello World!';\n  }\n}\n\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/data-source-migration.ts"',title:'"src/data-source-migration.ts"'},'import "reflect-metadata"\nimport { DataSource } from "typeorm"\nimport \'dotenv/config\'\n\nexport const AppDataSource = new DataSource({\n  type: "postgres",\n  host: process.env.DATABASE_HOST,\n  port: +process.env.DATABASE_PORT,\n  username: process.env.DATABASE_USER,\n  password: process.env.DATABASE_PASSWORD,\n  database: process.env.DATABASE_NAME,\n  synchronize: false,\n  logging: false,\n  migrations: ["./src/migration/*.ts"],\n  subscribers: [],\n})\n')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/data-source.ts"',title:'"src/data-source.ts"'},'import "reflect-metadata"\nimport { DataSource } from "typeorm"\nimport \'dotenv/config\'\nimport { join } from "path"\n\nexport const AppDataSource = new DataSource({\n  type: "postgres",\n  host: process.env.DATABASE_HOST,\n  port: +process.env.DATABASE_PORT,\n  username: process.env.DATABASE_USER,\n  password: process.env.DATABASE_PASSWORD,\n  database: process.env.DATABASE_NAME,\n  synchronize: false,\n  logging: false,\n  entities: [join(__dirname, \'**\', \'*.entity.{ts,js}\')],\n  subscribers: [],\n})\n')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/database.module.ts"',title:'"src/database.module.ts"'},"import { Module } from '@nestjs/common';\nimport { databaseProviders } from './database.providers';\n\n@Module({\n  providers: [...databaseProviders],\n  exports: [...databaseProviders],\n})\nexport class DatabaseModule { }\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/database.providers.ts"',title:'"src/database.providers.ts"'},"import { AppDataSource } from './data-source';\n\nexport const databaseProviders = [\n  {\n    provide: 'DATA_SOURCE',\n    useFactory: async () => {\n      return AppDataSource.initialize();\n    },\n  },\n];\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="src/main.ts"',title:'"src/main.ts"'},"import { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n  app.enableCors();\n  await app.listen(3000);\n}\nbootstrap();\n\n")),(0,s.kt)("h2",{id:"test"},"Test"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="test/app.e2e-spec.ts"',title:'"test/app.e2e-spec.ts"'},"import { Test, TestingModule } from '@nestjs/testing';\nimport { INestApplication } from '@nestjs/common';\nimport * as request from 'supertest';\nimport { AppModule } from './../src/app.module';\n\ndescribe('AppController (e2e)', () => {\n  let app: INestApplication;\n\n  beforeEach(async () => {\n    const moduleFixture: TestingModule = await Test.createTestingModule({\n      imports: [AppModule],\n    }).compile();\n\n    app = moduleFixture.createNestApplication();\n    await app.init();\n  });\n\n  it('/ (GET)', () => {\n    return request(app.getHttpServer())\n      .get('/')\n      .expect(200)\n      .expect('Hello World!');\n  });\n});\n\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="test/jest-e2e.json"',title:'"test/jest-e2e.json"'},'{\n  "moduleFileExtensions": [\n    "js",\n    "json",\n    "ts"\n  ],\n  "rootDir": ".",\n  "testEnvironment": "node",\n  "testRegex": ".e2e-spec.ts$",\n  "transform": {\n    "^.+\\\\.(t|j)s$": "ts-jest"\n  },\n  "moduleNameMapper": {\n    "^src/(.*)$": "<rootDir>/../src/$1"\n  }\n}\n')),(0,s.kt)("h2",{id:"root"},"Root"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title=".env.example"',title:'".env.example"'},'DATABASE_HOST=localhost\nDATABASE_NAME=fullstackbook-nestjs-jwt\nDATABASE_USER=postgres\nDATABASE_PASSWORD=\nDATABASE_PORT=5432\nAPP_NAME="Full Stack Book JWT"\n')),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-typescript",metastring:'title="package.json"',title:'"package.json"'},'{\n  "name": "fullstackbook-nestjs-jwt",\n  "version": "0.0.1",\n  "description": "",\n  "author": "",\n  "private": true,\n  "license": "UNLICENSED",\n  "scripts": {\n    "prebuild": "rimraf dist",\n    "build": "nest build",\n    "format": "prettier --write \\"src/**/*.ts\\" \\"test/**/*.ts\\"",\n    "start": "nest start",\n    "start:dev": "nest start --watch",\n    "start:debug": "nest start --debug --watch",\n    "start:prod": "node dist/main",\n    "lint": "eslint \\"{src,apps,libs,test}/**/*.ts\\" --fix",\n    "test": "jest",\n    "test:watch": "jest --watch",\n    "test:cov": "jest --coverage",\n    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",\n    "test:e2e": "jest --config ./test/jest-e2e.json",\n    "typeorm": "typeorm-ts-node-commonjs -d src/data-source-migration.ts"\n  },\n  "dependencies": {\n    "@nestjs/common": "^9.0.0",\n    "@nestjs/config": "^2.2.0",\n    "@nestjs/core": "^9.0.0",\n    "@nestjs/jwt": "^9.0.0",\n    "@nestjs/passport": "^9.0.0",\n    "@nestjs/platform-express": "^9.0.0",\n    "@nestjs/typeorm": "^9.0.1",\n    "bcrypt": "^5.1.0",\n    "passport": "^0.6.0",\n    "passport-jwt": "^4.0.0",\n    "passport-local": "^1.0.0",\n    "pg": "^8.8.0",\n    "reflect-metadata": "^0.1.13",\n    "rimraf": "^3.0.2",\n    "rxjs": "^7.2.0",\n    "typeorm": "^0.3.11"\n  },\n  "devDependencies": {\n    "@nestjs/cli": "^9.0.0",\n    "@nestjs/schematics": "^9.0.0",\n    "@nestjs/testing": "^9.0.0",\n    "@types/bcrypt": "^5.0.0",\n    "@types/express": "^4.17.13",\n    "@types/jest": "28.1.8",\n    "@types/node": "^16.0.0",\n    "@types/passport-jwt": "^3.0.7",\n    "@types/passport-local": "^1.0.34",\n    "@types/supertest": "^2.0.11",\n    "@typescript-eslint/eslint-plugin": "^5.0.0",\n    "@typescript-eslint/parser": "^5.0.0",\n    "eslint": "^8.0.1",\n    "eslint-config-prettier": "^8.3.0",\n    "eslint-plugin-prettier": "^4.0.0",\n    "jest": "28.1.3",\n    "prettier": "^2.3.2",\n    "source-map-support": "^0.5.20",\n    "supertest": "^6.1.3",\n    "ts-jest": "28.0.8",\n    "ts-loader": "^9.2.3",\n    "ts-node": "^10.0.0",\n    "tsconfig-paths": "4.1.0",\n    "typescript": "^4.7.4"\n  },\n  "jest": {\n    "moduleFileExtensions": [\n      "js",\n      "json",\n      "ts"\n    ],\n    "rootDir": "src",\n    "testRegex": ".*\\\\.spec\\\\.ts$",\n    "transform": {\n      "^.+\\\\.(t|j)s$": "ts-jest"\n    },\n    "collectCoverageFrom": [\n      "**/*.(t|j)s"\n    ],\n    "coverageDirectory": "../coverage",\n    "testEnvironment": "node",\n    "moduleNameMapper": {\n      "^src/(.*)$": "<rootDir>/$1"\n    }\n  }\n}\n')),(0,s.kt)("h2",{id:"reference"},"Reference"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://docs.nestjs.com/security/authentication"},"https://docs.nestjs.com/security/authentication")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://docs.nestjs.com/security/authorization"},"https://docs.nestjs.com/security/authorization")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://docs.nestjs.com/security/encryption-and-hashing"},"https://docs.nestjs.com/security/encryption-and-hashing")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://stackoverflow.com/questions/63865678/nestjs-test-suite-failed-to-run-cannot-find-module-src-article-article-entity"},"https://stackoverflow.com/questions/63865678/nestjs-test-suite-failed-to-run-cannot-find-module-src-article-article-entity")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("a",{parentName:"li",href:"https://stackoverflow.com/questions/59435293/typeorm-entity-in-nestjs-cannot-use-import-statement-outside-a-module"},"https://stackoverflow.com/questions/59435293/typeorm-entity-in-nestjs-cannot-use-import-statement-outside-a-module"))))}u.isMDXComponent=!0}}]);