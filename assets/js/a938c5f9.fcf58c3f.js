"use strict";(self.webpackChunkfullstackbook=self.webpackChunkfullstackbook||[]).push([[6665],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>c});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},p=Object.keys(e);for(a=0;a<p.length;a++)n=p[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);for(a=0;a<p.length;a++)n=p[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),s=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},m=function(e){var t=s(e.components);return a.createElement(o.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},k=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,p=e.originalType,o=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),k=s(n),c=r,d=k["".concat(o,".").concat(c)]||k[c]||u[c]||p;return n?a.createElement(d,i(i({ref:t},m),{},{components:n})):a.createElement(d,i({ref:t},m))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var p=n.length,i=new Array(p);i[0]=k;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var s=2;s<p;s++)i[s]=n[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}k.displayName="MDXCreateElement"},7387:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>i,default:()=>u,frontMatter:()=>p,metadata:()=>l,toc:()=>s});var a=n(7462),r=(n(7294),n(3905));const p={slug:"how-to-deploy-fastapi-with-pm2-and-connect-to-redis",title:"How To Deploy FastAPI With PM2 And Connect To Redis"},i=void 0,l={unversionedId:"guides/how-to-deploy-fastapi-with-pm2-and-connect-to-redis",id:"guides/how-to-deploy-fastapi-with-pm2-and-connect-to-redis",title:"How To Deploy FastAPI With PM2 And Connect To Redis",description:"- https://github.com/travisluong/fullstackbook-fastapi-redis/tree/v2",source:"@site/docs/guides/how-to-deploy-fastapi-with-pm2-and-connect-to-redis.md",sourceDirName:"guides",slug:"/guides/how-to-deploy-fastapi-with-pm2-and-connect-to-redis",permalink:"/docs/guides/how-to-deploy-fastapi-with-pm2-and-connect-to-redis",draft:!1,editUrl:"https://github.com/travisluong/fullstackbook/tree/main/docs/guides/how-to-deploy-fastapi-with-pm2-and-connect-to-redis.md",tags:[],version:"current",frontMatter:{slug:"how-to-deploy-fastapi-with-pm2-and-connect-to-redis",title:"How To Deploy FastAPI With PM2 And Connect To Redis"},sidebar:"guidesSidebar",previous:{title:"How To Deploy Express With Amazon EKS",permalink:"/docs/guides/how-to-deploy-express-with-amazon-eks"},next:{title:"How To Deploy Next.js With PM2",permalink:"/docs/guides/how-to-deploy-nextjs-with-pm2"}},o={},s=[{value:"Initial setup",id:"initial-setup",level:2},{value:"Provision server",id:"provision-server",level:2},{value:"Deployment Options",id:"deployment-options",level:2},{value:"Option 1: SSH Agent Forwarding",id:"option-1-ssh-agent-forwarding",level:3},{value:"Option 2: Deploy Key",id:"option-2-deploy-key",level:3},{value:"Deployment",id:"deployment",level:2},{value:"Set up domain",id:"set-up-domain",level:2},{value:"Set up SSL",id:"set-up-ssl",level:2},{value:"References",id:"references",level:2}],m={toc:s};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/travisluong/fullstackbook-fastapi-redis/tree/v2"},"https://github.com/travisluong/fullstackbook-fastapi-redis/tree/v2")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://youtu.be/vs8jF9kFszM"},"How To Deploy FastAPI With PM2 And Connect To AWS Redis"))),(0,r.kt)("h2",{id:"initial-setup"},"Initial setup"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"On local machine:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Install pm2."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"npm i pm2 -g\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Create a new FastAPI app. (See example app)")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Push to a private GitHub repo.")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"In the AWS Console:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Launch a compute instance running Ubuntu.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Download the pem key."),(0,r.kt)("li",{parentName:"ul"},"Note the security group."))),(0,r.kt)("li",{parentName:"ul"},"Go to Elasticache in AWS Console.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Create a new Redis cluster."))),(0,r.kt)("li",{parentName:"ul"},"Go to VPC in AWS Console.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Create a new security group for the redis cluster."),(0,r.kt)("li",{parentName:"ul"},"Set an inbound rule to allow Custom TCP traffic on port 6379 from the security group of the ec2 instance."),(0,r.kt)("li",{parentName:"ul"},"Go back to the redis cluster and assign it to the new security group."))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"On local machine:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Generate the pm2 ecosystem file."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"pm2 ecosystem\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Replace the values."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-js"},"module.exports = {\n  apps: [{\n    script: 'uvicorn main:app'\n  }],\n\n  deploy: {\n    production: {\n      key: 'key.pem',\n      user: 'ubuntu',\n      host: 'SSH_HOSTMACHINE',\n      ref: 'origin/main',\n      repo: 'GIT_REPOSITORY',\n      path: '/home/ubuntu',\n      'pre-deploy-local': '',\n      'post-deploy': 'source ~/.profile && source ~/.nvm/nvm.sh && python3 -m venv venv && . venv/bin/activate && pip install -r requirements.txt && pm2 reload ecosystem.config.js --env production',\n      'pre-setup': ''\n    }\n  }\n};\n\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Check in the file."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},'git add .\ngit commit -m "add ecosystem"\n'))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Push to GitHub."))))),(0,r.kt)("h2",{id:"provision-server"},"Provision server"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"On local machine:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Change pem permission."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"chmod 400 key.pem\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Copy the pem file into project root.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"SSH into server."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"ssh -i key.pem ubuntu@[SSH_HOSTMACHINE]\n"))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"On the server:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Install Node, PM2."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash\nsource .bashrc\nnvm install --lts\nnpm i -g pm2\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Install Nginx."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"sudo apt-get update\nsudo apt-get install -y nginx\nsudo service nginx restart\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Install Python3."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"sudo apt-get install -y python3 python3-venv python3-pip\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Install Redis. (See ",(0,r.kt)("a",{parentName:"p",href:"https://redis.io/docs/getting-started/installation/install-redis-on-linux/"},"https://redis.io/docs/getting-started/installation/install-redis-on-linux/"),")"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},'sudo apt install lsb-release\ncurl -fsSL https://packages.redis.io/gpg | sudo gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg\necho "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/redis.list\nsudo apt-get update\nsudo apt-get install redis\n'))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Test the redis connection with the cli."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"redis-cli fish.2lh6ar.ng.0001.usw2.cache.amazonaws.com\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Set the REDIS_HOST environment variable in ",(0,r.kt)("inlineCode",{parentName:"p"},"~/.profile"),". The endpoint can be found in the Elasticache dashboard in AWS Console."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"export REDIS_HOST=fish.2lh6ar.ng.0001.usw2.cache.amazonaws.com\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Go to the IP address in browser using http protocol and verify Nginx welcome page.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Configure Nginx."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"sudo vim /etc/nginx/conf.d/my-app.conf\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Insert the following configuration."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"server {  \n    listen 80;  \n    server_name SSH_HOSTMACHINE;\n    \n    location / {  \n        proxy_pass http://127.0.0.1:3000/;\n    }  \n}\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Restart Nginx."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"sudo service nginx restart\n")))))),(0,r.kt)("h2",{id:"deployment-options"},"Deployment Options"),(0,r.kt)("p",null,"Choose one of two deployment options:"),(0,r.kt)("h3",{id:"option-1-ssh-agent-forwarding"},"Option 1: SSH Agent Forwarding"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"On local machine:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Edit ssh config."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"vim ~/.ssh/config\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Insert the following."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"Host [SSH_HOSTMACHINE]\n      ForwardAgent yes\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Run ssh-add."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"ssh-add\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"SSH into server."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"ssh -i key.pem ubuntu@[SSH_HOSTMACHINE]\n"))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"On the server:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Verify connection to GitHub."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"ssh -T git@github.com\n")))))),(0,r.kt)("h3",{id:"option-2-deploy-key"},"Option 2: Deploy Key"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"On the server:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Run the ssh-keygen procedure."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"ssh-keygen\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Copy the public key."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"cat ~/.ssh/id_rsa.pub\n"))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"On GitHub:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Go to the repo Settings > Deploy keys > Add deploy key"),(0,r.kt)("li",{parentName:"ul"},"Paste the public key and click Add key.")))),(0,r.kt)("h2",{id:"deployment"},"Deployment"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"On local machine:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Run pm2 setup."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"pm2 deploy production setup\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Run deployment."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"pm2 deploy production\n")))))),(0,r.kt)("h2",{id:"set-up-domain"},"Set up domain"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Go to your DNS provider.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Point domain to IP address.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Wait for DNS propagation.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Verify DNS with dig."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"dig myapp.fullstackbook.com\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Change the Nginx configuration to use domain instead of IP."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"server {  \n  listen 80;  \n  server_name myapp.fullstackbook.com;\n  \n  location / {  \n        proxy_pass http://127.0.0.1:3000/;\n  }  \n}\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Restart Nginx."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"sudo service nginx restart\n")))),(0,r.kt)("h2",{id:"set-up-ssl"},"Set up SSL"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Go to ",(0,r.kt)("a",{parentName:"p",href:"https://certbot.eff.org"},"certbot.eff.org"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Select Nginx as the Software and Ubuntu as the System.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Follow the instructions. Below is a condensed version of the commands:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"sudo snap install core; sudo snap refresh core\nsudo apt-get remove certbot\nsudo snap install --classic certbot\nsudo ln -s /snap/bin/certbot /usr/bin/certbot\nsudo certbot --nginx\n")))),(0,r.kt)("h2",{id:"references"},"References"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://youtu.be/IwWQG6lEdQQ"},"https://youtu.be/IwWQG6lEdQQ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.github.com/en/developers/overview/managing-deploy-keys"},"https://docs.github.com/en/developers/overview/managing-deploy-keys")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://pm2.keymetrics.io/docs/usage/deployment/"},"https://pm2.keymetrics.io/docs/usage/deployment/"))))}u.isMDXComponent=!0}}]);