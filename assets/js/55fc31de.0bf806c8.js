"use strict";(self.webpackChunkfullstackbook=self.webpackChunkfullstackbook||[]).push([[2114],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>g});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=p(n),g=o,k=m["".concat(l,".").concat(g)]||m[g]||u[g]||i;return n?r.createElement(k,a(a({ref:t},c),{},{components:n})):r.createElement(k,a({ref:t},c))}));function g(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,a=new Array(i);a[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,a[1]=s;for(var p=2;p<i;p++)a[p]=n[p];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5904:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var r=n(7462),o=(n(7294),n(3905));const i={},a="Spring Boot JWT API",s={unversionedId:"code/springboot-jwt",id:"code/springboot-jwt",title:"Spring Boot JWT API",description:"- GitHub//github.com/travisluong/fullstackbook-jwt-springboot",source:"@site/docs/code/springboot-jwt.md",sourceDirName:"code",slug:"/code/springboot-jwt",permalink:"/code/springboot-jwt",draft:!1,editUrl:"https://github.com/travisluong/fullstackbook/tree/main/docs/code/springboot-jwt.md",tags:[],version:"current",frontMatter:{},sidebar:"codeSidebar",previous:{title:"Spring Data JPA Projections",permalink:"/code/spring-data-jpa-projections"},next:{title:"Spring Boot To Do API",permalink:"/code/springboot-todo"}},l={},p=[{value:"Dependencies",id:"dependencies",level:2},{value:"Config",id:"config",level:2},{value:"Controller",id:"controller",level:2},{value:"DTO",id:"dto",level:2},{value:"Filter",id:"filter",level:2},{value:"Model",id:"model",level:2},{value:"Repository",id:"repository",level:2},{value:"Service",id:"service",level:2},{value:"Util",id:"util",level:2},{value:"App",id:"app",level:2},{value:"Migration",id:"migration",level:2},{value:"Properties",id:"properties",level:2},{value:"References",id:"references",level:2}],c={toc:p};function u(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"spring-boot-jwt-api"},"Spring Boot JWT API"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"GitHub: ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/travisluong/fullstackbook-jwt-springboot"},"https://github.com/travisluong/fullstackbook-jwt-springboot")),(0,o.kt)("li",{parentName:"ul"},"YouTube: ",(0,o.kt)("a",{parentName:"li",href:"https://youtu.be/kj6wRnXQDKI"},"Full Stack Spring Boot + NextJS JWT Authentication Tutorial"))),(0,o.kt)("h2",{id:"dependencies"},"Dependencies"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Lombok"),(0,o.kt)("li",{parentName:"ul"},"Spring Web"),(0,o.kt)("li",{parentName:"ul"},"Spring Security"),(0,o.kt)("li",{parentName:"ul"},"Spring Data JPA"),(0,o.kt)("li",{parentName:"ul"},"Flyway Migration"),(0,o.kt)("li",{parentName:"ul"},"PostgreSQL Driver")),(0,o.kt)("h2",{id:"config"},"Config"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/config/CorsConfiguration.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/config/CorsConfiguration.java"'},'package com.example.fullstackbookjwtspringboot.config;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.web.servlet.config.annotation.CorsRegistry;\nimport org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n\n@Configuration\npublic class CorsConfiguration {\n    @Bean\n    public WebMvcConfigurer corsConfigurer() {\n        return new WebMvcConfigurer() {\n            @Override\n            public void addCorsMappings(CorsRegistry registry) {\n                registry.addMapping("/**").allowedMethods("GET", "PUT", "POST", "DELETE").allowedOrigins("http://localhost:3000");\n            }\n        };\n    }\n}\n\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/config/SecurityConfiguration.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/config/SecurityConfiguration.java"'},'package com.example.fullstackbookjwtspringboot.config;\n\nimport com.example.fullstackbookjwtspringboot.filter.AuthTokenFilter;\nimport com.example.fullstackbookjwtspringboot.service.AuthEntryPointJwt;\nimport com.example.fullstackbookjwtspringboot.service.UserDetailsServiceImpl;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Primary;\nimport org.springframework.security.authentication.AuthenticationManager;\nimport org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\nimport org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;\nimport org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.http.SessionCreationPolicy;\nimport org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;\n\n@Configuration\n@EnableWebSecurity\n@EnableGlobalMethodSecurity(prePostEnabled = true)\npublic class SecurityConfiguration {\n    private UserDetailsServiceImpl userDetailsService;\n    private AuthEntryPointJwt authEntryPointJwt;\n    private AuthTokenFilter authTokenFilter;\n\n    public SecurityConfiguration(UserDetailsServiceImpl userDetailsService, AuthEntryPointJwt authEntryPointJwt, AuthTokenFilter authTokenFilter) {\n        this.userDetailsService = userDetailsService;\n        this.authEntryPointJwt = authEntryPointJwt;\n        this.authTokenFilter = authTokenFilter;\n    }\n\n    @Bean\n    public PasswordEncoder passwordEncoder() {\n        return new BCryptPasswordEncoder();\n    }\n\n    @Bean\n    public AuthenticationManager authenticationManager(AuthenticationConfiguration authenticationConfiguration) throws Exception {\n        return authenticationConfiguration.getAuthenticationManager();\n    }\n\n    @Bean\n    @Primary\n    public AuthenticationManagerBuilder configureAuthenticationManagerBuilder(AuthenticationManagerBuilder authenticationManagerBuilder) throws Exception {\n        authenticationManagerBuilder.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());\n        return authenticationManagerBuilder;\n    }\n\n    @Bean\n    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {\n        http.cors().and().csrf().disable()\n                .exceptionHandling().authenticationEntryPoint(authEntryPointJwt).and()\n                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()\n                .authorizeRequests().antMatchers("/api/auth/**").permitAll()\n                .antMatchers("/api/test/**").permitAll()\n                .anyRequest().authenticated();\n        http.addFilterBefore(authTokenFilter, UsernamePasswordAuthenticationFilter.class);\n        return http.build();\n    }\n}\n')),(0,o.kt)("h2",{id:"controller"},"Controller"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/controller/AuthController.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/controller/AuthController.java"'},'package com.example.fullstackbookjwtspringboot.controller;\n\nimport com.example.fullstackbookjwtspringboot.dto.JwtResponse;\nimport com.example.fullstackbookjwtspringboot.dto.SignInRequest;\nimport com.example.fullstackbookjwtspringboot.dto.SignUpRequest;\nimport com.example.fullstackbookjwtspringboot.model.ERole;\nimport com.example.fullstackbookjwtspringboot.model.Role;\nimport com.example.fullstackbookjwtspringboot.model.User;\nimport com.example.fullstackbookjwtspringboot.repository.RoleRepository;\nimport com.example.fullstackbookjwtspringboot.repository.UserRepository;\nimport com.example.fullstackbookjwtspringboot.service.UserDetailsImpl;\nimport com.example.fullstackbookjwtspringboot.util.JwtUtil;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.authentication.AuthenticationManager;\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.web.bind.annotation.*;\n\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Optional;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\n@RestController\n@RequestMapping("/api/auth")\npublic class AuthController {\n    private UserRepository userRepository;\n    private RoleRepository roleRepository;\n    private PasswordEncoder passwordEncoder;\n    private AuthenticationManager authenticationManager;\n    private JwtUtil jwtUtil;\n\n    public AuthController(UserRepository userRepository,\n                          PasswordEncoder passwordEncoder,\n                          RoleRepository roleRepository,\n                          AuthenticationManager authenticationManager,\n                          JwtUtil jwtUtil) {\n        this.userRepository = userRepository;\n        this.roleRepository = roleRepository;\n        this.passwordEncoder = passwordEncoder;\n        this.authenticationManager = authenticationManager;\n        this.jwtUtil = jwtUtil;\n    }\n\n    @PostMapping("/signin")\n    public ResponseEntity<?> signin(@RequestBody SignInRequest signInRequest) {\n        Authentication authentication = authenticationManager.authenticate(new UsernamePasswordAuthenticationToken(signInRequest.getUsername(), signInRequest.getPassword()));\n        SecurityContextHolder.getContext().setAuthentication(authentication);\n        String jwt = jwtUtil.generateJwtToken(authentication);\n        UserDetailsImpl userDetails = (UserDetailsImpl) authentication.getPrincipal();\n        List<String> roles = userDetails.getAuthorities().stream()\n                .map(item -> item.getAuthority())\n                .collect(Collectors.toList());\n        JwtResponse res = new JwtResponse();\n        res.setToken(jwt);\n        res.setId(userDetails.getId());\n        res.setUsername(userDetails.getUsername());\n        res.setRoles(roles);\n        return ResponseEntity.ok(res);\n    }\n\n    @PostMapping("/signup")\n    public ResponseEntity<String> signup(@RequestBody SignUpRequest signUpRequest) {\n        if (userRepository.existsByUsername(signUpRequest.getUsername())) {\n            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("username is already taken");\n        }\n        if (userRepository.existsByEmail(signUpRequest.getEmail())) {\n            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("email is already taken");\n        }\n        String hashedPassword = passwordEncoder.encode(signUpRequest.getPassword());\n        Set<Role> roles = new HashSet<>();\n        Optional<Role> userRole = roleRepository.findByName(ERole.ROLE_USER);\n        if (userRole.isEmpty()) {\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("role not found");\n        }\n        roles.add(userRole.get());\n        User user = new User();\n        user.setUsername(signUpRequest.getUsername());\n        user.setEmail(signUpRequest.getEmail());\n        user.setPassword(hashedPassword);\n        user.setRoles(roles);\n        userRepository.save(user);\n        return ResponseEntity.ok("User registered success");\n    }\n}\n\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/controller/TestController.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/controller/TestController.java"'},'package com.example.fullstackbookjwtspringboot.controller;\n\nimport com.example.fullstackbookjwtspringboot.service.UserDetailsImpl;\nimport com.fasterxml.jackson.databind.JsonNode;\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport lombok.extern.log4j.Log4j2;\nimport org.apache.coyote.Response;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.security.core.context.SecurityContext;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\n@RequestMapping("/api/test")\n@Log4j2\npublic class TestController {\n    @GetMapping("/all")\n    public String allAccess() {\n        return "Public Content.";\n    }\n\n    @GetMapping("/user")\n    @PreAuthorize("hasRole(\'USER\') or hasRole(\'MODERATOR\') or hasRole(\'ADMIN\')")\n    public String userAccess() {\n        return "User Content.";\n    }\n\n    @GetMapping("/mod")\n    @PreAuthorize("hasRole(\'MODERATOR\')")\n    public String moderatorAccess() {\n        return "Moderator Board.";\n    }\n\n    @GetMapping("/admin")\n    @PreAuthorize("hasRole(\'ADMIN\')")\n    public String adminAccess() {\n        return "Admin Board.";\n    }\n\n    @GetMapping("/profile")\n    @PreAuthorize("hasRole(\'USER\') or hasRole(\'MODERATOR\') or hasRole(\'ADMIN\')")\n    public UserDetailsImpl profile() {\n        SecurityContext context = SecurityContextHolder.getContext();\n        Authentication authentication = context.getAuthentication();\n        UserDetailsImpl userDetails = (UserDetailsImpl) authentication.getPrincipal();\n        log.info("username: {}", userDetails.getUsername());\n        return userDetails;\n    }\n}\n\n')),(0,o.kt)("h2",{id:"dto"},"DTO"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/dto/JwtResponse.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/dto/JwtResponse.java"'},'package com.example.fullstackbookjwtspringboot.dto;\n\nimport lombok.Data;\nimport lombok.NoArgsConstructor;\n\nimport java.util.List;\n\n@Data\n@NoArgsConstructor\npublic class JwtResponse {\n    private String token;\n    private String type = "Bearer";\n    private Long id;\n    private String username;\n    private List<String> roles;\n}\n\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/dto/SignInRequest.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/dto/SignInRequest.java"'},"package com.example.fullstackbookjwtspringboot.dto;\n\nimport lombok.Data;\n\n@Data\npublic class SignInRequest {\n    private String username;\n    private String password;\n}\n\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/dto/SignUpRequest.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/dto/SignUpRequest.java"'},"package com.example.fullstackbookjwtspringboot.dto;\n\nimport lombok.Data;\n\n@Data\npublic class SignUpRequest {\n    private String username;\n    private String email;\n    private String password;\n}\n\n")),(0,o.kt)("h2",{id:"filter"},"Filter"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/filter/AuthTokenFilter.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/filter/AuthTokenFilter.java"'},'package com.example.fullstackbookjwtspringboot.filter;\n\nimport com.example.fullstackbookjwtspringboot.service.UserDetailsServiceImpl;\nimport com.example.fullstackbookjwtspringboot.util.JwtUtil;\nimport lombok.extern.log4j.Log4j2;\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.web.authentication.WebAuthenticationDetailsSource;\nimport org.springframework.stereotype.Component;\nimport org.springframework.util.StringUtils;\nimport org.springframework.web.filter.OncePerRequestFilter;\n\nimport javax.servlet.FilterChain;\nimport javax.servlet.ServletException;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport java.io.IOException;\n\n@Log4j2\n@Component\npublic class AuthTokenFilter extends OncePerRequestFilter {\n    private JwtUtil jwtUtil;\n    private UserDetailsServiceImpl userDetailsService;\n\n    public AuthTokenFilter(JwtUtil jwtUtil, UserDetailsServiceImpl userDetailsService) {\n        this.jwtUtil = jwtUtil;\n        this.userDetailsService = userDetailsService;\n    }\n\n    @Override\n    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {\n        try {\n            String jwt = parseJwt(request);\n            if (jwt != null && jwtUtil.validateJwtToken(jwt)) {\n                String username = jwtUtil.getUserNameFromJwtToken(jwt);\n                UserDetails userDetails = userDetailsService.loadUserByUsername(username);\n                UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(userDetails, null,\n                        userDetails.getAuthorities());\n                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));\n                SecurityContextHolder.getContext().setAuthentication(authentication);\n            }\n        } catch (Exception e) {\n            log.error("Cannot set user authentication: {}", e);\n        }\n        filterChain.doFilter(request, response);\n    }\n\n    private String parseJwt(HttpServletRequest request) {\n        String headerAuth = request.getHeader("Authorization");\n        if (StringUtils.hasText(headerAuth) && headerAuth.startsWith("Bearer ")) {\n            return headerAuth.substring(7);\n        }\n        return null;\n    }\n}\n\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/filter/TestFilter.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/filter/TestFilter.java"'},'package com.example.fullstackbookjwtspringboot.filter;\n\nimport org.springframework.stereotype.Component;\nimport org.springframework.web.filter.OncePerRequestFilter;\n\nimport javax.servlet.FilterChain;\nimport javax.servlet.ServletException;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport java.io.IOException;\n\n@Component\npublic class TestFilter extends OncePerRequestFilter {\n    @Override\n    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {\n        String tokenHeader = request.getHeader("Authorization");\n        System.out.println("tokenHeader = " + tokenHeader);\n        filterChain.doFilter(request, response);\n    }\n}\n\n')),(0,o.kt)("h2",{id:"model"},"Model"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/model/ERole.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/model/ERole.java"'},"package com.example.fullstackbookjwtspringboot.model;\n\npublic enum ERole {\n    ROLE_USER,\n    ROLE_ADMIN,\n    ROLE_MODERATOR\n}\n\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/model/Role.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/model/Role.java"'},'package com.example.fullstackbookjwtspringboot.model;\n\nimport javax.persistence.*;\n\n@Entity\n@Table(name = "roles")\npublic class Role {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n\n    @Enumerated(EnumType.STRING)\n    @Column\n    private ERole name;\n\n    public ERole getName() {\n        return name;\n    }\n}\n\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/model/User.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/model/User.java"'},'package com.example.fullstackbookjwtspringboot.model;\n\nimport lombok.AllArgsConstructor;\nimport lombok.Data;\nimport lombok.NoArgsConstructor;\n\nimport javax.persistence.*;\nimport java.util.HashSet;\nimport java.util.Set;\n\n@Entity\n@Table(name = "users")\n@Data\n@NoArgsConstructor\npublic class User {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n\n    @Column\n    private String username;\n\n    @Column\n    private String email;\n\n    @Column\n    private String password;\n\n    @ManyToMany(fetch = FetchType.EAGER)\n    @JoinTable(name = "users_to_roles",\n            joinColumns = @JoinColumn(name="user_id"),\n            inverseJoinColumns = @JoinColumn(name="role_id"))\n    private Set<Role> roles = new HashSet<>();\n\n    public void setRoles(Set<Role> roles) {\n        this.roles = roles;\n    }\n}\n\n')),(0,o.kt)("h2",{id:"repository"},"Repository"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/repository/RoleRepository.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/repository/RoleRepository.java"'},"package com.example.fullstackbookjwtspringboot.repository;\n\nimport com.example.fullstackbookjwtspringboot.model.ERole;\nimport com.example.fullstackbookjwtspringboot.model.Role;\nimport org.springframework.data.jpa.repository.JpaRepository;\n\nimport java.util.Optional;\n\npublic interface RoleRepository extends JpaRepository<Role, Long> {\n    Optional<Role> findByName(ERole name);\n}\n\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/repository/UserRepository.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/repository/UserRepository.java"'},"package com.example.fullstackbookjwtspringboot.repository;\n\nimport com.example.fullstackbookjwtspringboot.model.User;\nimport org.springframework.data.jpa.repository.JpaRepository;\n\nimport java.util.Optional;\n\npublic interface UserRepository extends JpaRepository<User, Long> {\n    Optional<User> findByUsername(String username);\n    Boolean existsByUsername(String username);\n    Boolean existsByEmail(String email);\n}\n\n")),(0,o.kt)("h2",{id:"service"},"Service"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/service/AuthEntryPointJwt.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/service/AuthEntryPointJwt.java"'},'package com.example.fullstackbookjwtspringboot.service;\n\nimport lombok.extern.log4j.Log4j2;\nimport org.springframework.security.core.AuthenticationException;\nimport org.springframework.security.web.AuthenticationEntryPoint;\nimport org.springframework.stereotype.Component;\n\nimport javax.servlet.ServletException;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport java.io.IOException;\n\n@Log4j2\n@Component\npublic class AuthEntryPointJwt implements AuthenticationEntryPoint {\n    @Override\n    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException) throws IOException, ServletException {\n       log.error("Unauthorized error: {}", authException.getMessage());\n       response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "Error: Unauthorized");\n    }\n}\n\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/service/UserDetailsImpl.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/service/UserDetailsImpl.java"'},"package com.example.fullstackbookjwtspringboot.service;\n\nimport com.example.fullstackbookjwtspringboot.model.User;\nimport com.fasterxml.jackson.annotation.JsonIgnore;\nimport org.springframework.security.core.GrantedAuthority;\nimport org.springframework.security.core.authority.SimpleGrantedAuthority;\nimport org.springframework.security.core.userdetails.UserDetails;\n\nimport java.util.Collection;\nimport java.util.List;\nimport java.util.stream.Collectors;\n\npublic class UserDetailsImpl implements UserDetails {\n\n    private Long id;\n    private String username;\n    private String email;\n    @JsonIgnore\n    private String password;\n    private Collection<? extends GrantedAuthority> authorities;\n    public UserDetailsImpl(Long id, String username, String email, String password,\n                           Collection<? extends GrantedAuthority> authorities) {\n        this.id = id;\n        this.username = username;\n        this.email = email;\n        this.password = password;\n        this.authorities = authorities;\n    }\n    public static UserDetailsImpl build(User user) {\n        List<GrantedAuthority> authorities = user.getRoles().stream()\n                .map(role -> new SimpleGrantedAuthority(role.getName().name()))\n                .collect(Collectors.toList());\n        return new UserDetailsImpl(\n                user.getId(),\n                user.getUsername(),\n                user.getEmail(),\n                user.getPassword(),\n                authorities);\n    }\n\n    @Override\n    public Collection<? extends GrantedAuthority> getAuthorities() {\n        return authorities;\n    }\n\n    @Override\n    public String getPassword() {\n        return password;\n    }\n\n    @Override\n    public String getUsername() {\n        return username;\n    }\n\n    @Override\n    public boolean isAccountNonExpired() {\n        return true;\n    }\n\n    @Override\n    public boolean isAccountNonLocked() {\n        return true;\n    }\n\n    @Override\n    public boolean isCredentialsNonExpired() {\n        return true;\n    }\n\n    @Override\n    public boolean isEnabled() {\n        return true;\n    }\n\n    public Long getId() {\n        return id;\n    }\n}\n\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/service/UserDetailsServiceImpl.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/service/UserDetailsServiceImpl.java"'},'package com.example.fullstackbookjwtspringboot.service;\n\nimport com.example.fullstackbookjwtspringboot.model.User;\nimport com.example.fullstackbookjwtspringboot.repository.UserRepository;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.security.core.userdetails.UsernameNotFoundException;\nimport org.springframework.stereotype.Service;\n\n@Service\npublic class UserDetailsServiceImpl implements UserDetailsService {\n    private UserRepository userRepository;\n\n    public UserDetailsServiceImpl(UserRepository userRepository) {\n        this.userRepository = userRepository;\n    }\n\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        User user = userRepository.findByUsername(username).orElseThrow(() -> new UsernameNotFoundException("User not found with username" + username));\n        return UserDetailsImpl.build(user);\n    }\n}\n\n')),(0,o.kt)("h2",{id:"util"},"Util"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/util/JwtUtil.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/util/JwtUtil.java"'},'package com.example.fullstackbookjwtspringboot.util;\n\nimport com.example.fullstackbookjwtspringboot.service.UserDetailsImpl;\nimport io.jsonwebtoken.*;\nimport lombok.extern.log4j.Log4j2;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.stereotype.Component;\n\nimport java.util.Date;\n\n@Component\n@Log4j2\npublic class JwtUtil {\n    @Value("${fullstackbook.app.jwtSecret}")\n    private String jwtSecret;\n\n    @Value("${fullstackbook.app.jwtExpirationMs}")\n    private int jwtExpirationMs;\n\n    public String generateJwtToken(Authentication authentication) {\n        UserDetailsImpl userPrincipal = (UserDetailsImpl) authentication.getPrincipal();\n        return Jwts.builder().setSubject((userPrincipal.getUsername())).setIssuedAt(new Date())\n                .setExpiration(new Date((new Date()).getTime() + jwtExpirationMs)).signWith(SignatureAlgorithm.HS512, jwtSecret)\n                .compact();\n    }\n\n    public String getUserNameFromJwtToken(String token) {\n        return Jwts.parser().setSigningKey(jwtSecret).parseClaimsJws(token).getBody().getSubject();\n    }\n\n    public boolean validateJwtToken(String authToken) {\n        try {\n            Jwts.parser().setSigningKey(jwtSecret).parseClaimsJws(authToken);\n            return true;\n        } catch (SignatureException e) {\n            log.error("Invalid JWT signature: {}", e.getMessage());\n        } catch (MalformedJwtException e) {\n            log.error("Invalid JWT token: {}", e.getMessage());\n        } catch (ExpiredJwtException e) {\n            log.error("JWT token is expired: {}", e.getMessage());\n        } catch (UnsupportedJwtException e) {\n            log.error("JWT token is unsupported: {}", e.getMessage());\n        } catch (IllegalArgumentException e) {\n            log.error("JWT claims string is empty: {}", e.getMessage());\n        }\n        return false;\n    }\n}\n\n')),(0,o.kt)("h2",{id:"app"},"App"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="src/main/java/com/example/fullstackbookjwtspringboot/FullstackbookJwtSpringbootApplication.java"',title:'"src/main/java/com/example/fullstackbookjwtspringboot/FullstackbookJwtSpringbootApplication.java"'},"package com.example.fullstackbookjwtspringboot;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\n\n@SpringBootApplication\npublic class FullstackbookJwtSpringbootApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(FullstackbookJwtSpringbootApplication.class, args);\n    }\n\n}\n\n")),(0,o.kt)("h2",{id:"migration"},"Migration"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="src/main/resources/db/migration/V1__create_roles_table.sql"',title:'"src/main/resources/db/migration/V1__create_roles_table.sql"'},"create table roles (\n    id serial primary key,\n    name text not null unique\n);\n\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="src/main/resources/db/migration/V2__create_users_table.sql"',title:'"src/main/resources/db/migration/V2__create_users_table.sql"'},"create table users (\n    id serial primary key,\n    username text not null,\n    email text not null,\n    password text\n);\n\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="src/main/resources/db/migration/V3__create_users_to_roles_table.sql"',title:'"src/main/resources/db/migration/V3__create_users_to_roles_table.sql"'},"create table users_to_roles (\n    user_id int references users (id),\n    role_id int references roles (id)\n);\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="src/main/resources/db/migration/V4__insert_roles.sql"',title:'"src/main/resources/db/migration/V4__insert_roles.sql"'},"insert into roles (name) values ('ROLE_USER');\ninsert into roles (name) values ('ROLE_MODERATOR');\ninsert into roles (name) values ('ROLE_ADMIN');\n")),(0,o.kt)("h2",{id:"properties"},"Properties"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-txt",metastring:'title="src/main/resources/application.properties"',title:'"src/main/resources/application.properties"'},"\nspring.datasource.url=jdbc:postgresql://localhost:5432/fullstackbook-jwt-springboot\nspring.datasource.username=postgres\nspring.datasource.password=\n#spring.security.user.name=foo\n#spring.security.user.password=bar\nfullstackbook.app.jwtSecret=mysecret\nfullstackbook.app.jwtExpirationMs=86400000\n")),(0,o.kt)("h2",{id:"references"},"References"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.bezkoder.com/spring-boot-security-postgresql-jwt-authentication/"},"https://www.bezkoder.com/spring-boot-security-postgresql-jwt-authentication/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://spring.io/blog/2022/02/21/spring-security-without-the-websecurityconfigureradapter"},"https://spring.io/blog/2022/02/21/spring-security-without-the-websecurityconfigureradapter")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.spring.io/spring-security/reference/index.html"},"https://docs.spring.io/spring-security/reference/index.html"))))}u.isMDXComponent=!0}}]);